
# End-to-End Bulk RNA-Seq Pipeline (CRC Â· PRJNA413956)

A reproducible workflow using **Conda**, command-line tools (**SRA-Toolkit**, **Trim Galore!**, **Salmon**), and **PySpark**/**pyfastx** to process raw RNA-seq reads from the first 10 samples (5 Tumor/5 Normal pairs) of the colorectal cancer (CRC) study **PRJNA413956**. The pipeline generates transcript quantifications and performs exploratory analysis integrating expression with sequence features (GC%). ğŸ§¬

---

## Data Source

-   **BioProject:** PRJNA413956 â€” â€œDifferentially expressed lncRNAs and mRNA identified by SEQ analysis in colorectal cancer patients.â€
-   **GEO Series:** GSE104836 â€” *10 paired tissues (non-tumor and CRC) generated by deep sequencing.* (This analysis uses the first 10 samples corresponding to SRR6191649â€“SRR6191658).
-   **Links:** [NCBI BioProject page](https://www.ncbi.nlm.nih.gov/bioproject/PRJNA413956) and [GEO series page](https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE104836).

> **Note:** Raw FASTQ reads are obtained from SRA; quantification is performed against a GENCODE transcriptome.

---

## Repository Layout

```

PRJNA413956/
â”œâ”€â”€ .ipynb\_checkpoints/            \# Jupyter auto-saves (can be ignored)
â”œâ”€â”€ Dockerfile                     \# Docker configuration (if used)
â”œâ”€â”€ PRJNA413956.ipynb              \# PySpark/pyfastx analysis notebook (GC%, Î”log10(TPM), etc.)
â”œâ”€â”€ README.md                      \# This file
â”œâ”€â”€ environment.yml                \# Conda environment definition
â”œâ”€â”€ gencode.v46.transcripts.fa     \# Transcriptome FASTA (required for notebook)
â”œâ”€â”€ gencode.v46.transcripts.fa.fxi \# pyfastx index (generated by notebook) 
â””â”€â”€ quants/                        \# Salmon results (created by CLI pipeline)
â”œâ”€â”€ SRR6191649\_quant/
â”œâ”€â”€ SRR6191650\_quant/
â”œâ”€â”€ SRR6191651\_quant/
â”œâ”€â”€ SRR6191652\_quant/
â”œâ”€â”€ SRR6191653\_quant/
â”œâ”€â”€ SRR6191654\_quant/
â”œâ”€â”€ SRR6191655\_quant/
â”œâ”€â”€ SRR6191656\_quant/
â”œâ”€â”€ SRR6191657\_quant/
â””â”€â”€ SRR6191658\_quant/
â”œâ”€â”€ quant.sf
â”œâ”€â”€ cmd\_info.json
â””â”€â”€ lib\_format\_counts.json

````

*(Note: `.fq.gz` files generated during the CLI pipeline are typically large and might be excluded from version control).*

---

## Requirements

Run on Linux (or WSL). A Conda environment is required.

```yaml
# environment.yml
name: rnaseq
channels: [conda-forge, bioconda, defaults]
dependencies:
  # Python & Data Analysis
  - python=3.11 # Updated to match notebook environment
  - pyspark
  - pandas
  - matplotlib
  - seaborn
  - pyfastx
  - scipy        # For linregress
  - statsmodels  # For LOESS smoothing
  - fpdf         # For PDF report generation (optional)

  # Bioinformatics CLI Tools
  - entrez-direct
  - sra-tools
  - trim-galore
  - fastqc       # Trim Galore dependency
  - cutadapt     # Trim Galore dependency
  - salmon
  - parallel     # For parallel processing
````

**Setup**

```bash
conda env create -f environment.yml
conda activate rnaseq
```

**Reference Files**

  * A **Salmon index** built from your chosen transcriptome (e.g., GENCODE v46). Ensure the path in the bash script is correct.
  * The corresponding **FASTA** file (e.g., `gencode.v46.transcripts.fa`) placed in the project root for the notebook analysis.

-----

## 1\) Command-Line Processing (SRA â†’ Salmon) âš™ï¸

Execute the following script from the project root directory. **Ensure you update `/path/to/your/salmon_index`**.

```bash
#!/usr/bin/env bash
set -euo pipefail

# --- Configuration ---
BIOPROJECT="PRJNA413956"
SALMON_INDEX="/path/to/your/salmon_index" # <<< UPDATE THIS PATH
THREADS=8 # Adjust based on your system cores
PARALLEL_JOBS=4 # Adjust based on your system/network
SRR_COUNT=10 # Number of SRR samples to process

# --- Script ---
echo "Fetching SRR IDs for ${BIOPROJECT}..."
SRR_FILE="${BIOPROJECT}_srr_ids.txt"
esearch -db sra -query "${BIOPROJECT}" \
  | efetch -format runinfo \
  | cut -d',' -f1 \
  | grep '^SRR' \
  | head -n ${SRR_COUNT} > "${SRR_FILE}"

echo "Downloading SRR files in parallel (Jobs=${PARALLEL_JOBS})..."
cat "${SRR_FILE}" | parallel -j ${PARALLEL_JOBS} 'echo "Prefetching {}..."; prefetch --verify no {}'

echo "Converting SRA to FASTQ and trimming reads..."
cat "${SRR_FILE}" | while read SRR; do
  echo "Processing ${SRR}..."
  if [[ ! -f "${SRR}_1.fastq.gz" || ! -f "${SRR}_2.fastq.gz" ]]; then
    fastq-dump --split-files --gzip "${SRR}"
  else
    echo "  FASTQ files already exist, skipping fastq-dump."
  fi
  if [[ ! -f "${SRR}_1_val_1.fq.gz" || ! -f "${SRR}_2_val_2.fq.gz" ]]; then
    trim_galore --paired --fastqc --cores 4 "${SRR}_1.fastq.gz" "${SRR}_2.fastq.gz"
  else
    echo "  Trimmed files already exist, skipping trim_galore."
  fi
  # Optional: Clean up intermediate FASTQ files if desired
  # rm -f "${SRR}_1.fastq.gz" "${SRR}_2.fastq.gz"
done

echo "Quantifying expression with Salmon (Threads=${THREADS})..."
mkdir -p quants
for R1 in *_1_val_1.fq.gz; do
  SAMPLE="${R1%_1_val_1.fq.gz}"
  OUTDIR="quants/${SAMPLE}_quant"
  # Check if SAMPLE is in our SRR list before quantifying
  if grep -q "^${SAMPLE}$" "${SRR_FILE}"; then
      if [[ ! -f "${OUTDIR}/quant.sf" ]]; then
        echo "  Quantifying ${SAMPLE}..."
        salmon quant \
          -i "${SALMON_INDEX}" \
          -l A \
          -1 "${SAMPLE}_1_val_1.fq.gz" \
          -2 "${SAMPLE}_2_val_2.fq.gz" \
          --validateMappings \
          -p ${THREADS} \
          -o "${OUTDIR}"
      else
        echo "  Quantification for ${SAMPLE} already exists, skipping."
      fi
  fi
done

echo "Command-line pipeline complete. âœ…"
```

**Output Structure per Sample (Salmon)**

```
quants/SRRxxxxxxx_quant/
â”œâ”€â”€ quant.sf                  # Main quantification results
â”œâ”€â”€ cmd_info.json             # Salmon command parameters
â””â”€â”€ lib_format_counts.json    # Library type estimation data
```

-----

## 2\) Downstream Analysis (PySpark + pyfastx) ğŸ“Š

Open and run the **`PRJNA413956.ipynb`** notebook to:

1.  Load all 10 `quant.sf` files into a Spark DataFrame (`expression_all_samples`).
2.  Parse transcript GC% and length from `gencode.v46.transcripts.fa` using **pyfastx**, creating a `sequence_features` DataFrame.
3.  Add sample condition metadata ('Tumor'/'Normal') based on SRR ID parity.
4.  Join expression, features, and metadata into a `full_data` view.
5.  Generate plots exploring the relationship between GC content and expression (saved within the notebook or optionally to PDF/PNG via provided code snippets).
6.  (Optional) Generate a summary PDF report.

-----

## Outputs

  * **`quants/`**: Salmon quantification results for each of the 10 samples.
  * **Figures/plots** produced in the notebook (either embedded or saved to disk via specific code cells).
  * **Data tables/CSVs** if explicitly saved by the notebook code.

-----

## Reproducibility Notes

  * Salmon `quant.sf` files contain the primary quantification data. `cmd_info.json` provides provenance for the Salmon run.
  * For archival (e.g., on Zenodo), consider packaging the relevant files within the `quants/` directory (e.g., `quant.sf`, `cmd_info.json`, `lib_format_counts.json`) along with a manifest file.

**Example Manifest Creation:**

```bash
{
  echo "Sample,quant_sf,cmd_info,lib_format_counts"
  # Use find for robustness, especially if directory structure varies
  find quants -maxdepth 2 -type f -name 'quant.sf' | while read QSF; do
    DDIR=$(dirname "$QSF")
    SAMPLE=$(basename "$DDIR")
    CMD_INFO="${DDIR}/cmd_info.json"
    LIB_COUNTS="${DDIR}/lib_format_counts.json"
    # Check if other files exist, provide placeholders if not
    [[ ! -f "$CMD_INFO" ]] && CMD_INFO="NA"
    [[ ! -f "$LIB_COUNTS" ]] && LIB_COUNTS="NA"
    echo "$SAMPLE,$QSF,$CMD_INFO,$LIB_COUNTS"
  done
} > quants_manifest.csv
```

-----

## Citation & Licensing

  * **Source Study:** Please cite the original publication associated with PRJNA413956/GSE104836 when using these data or results derived from them.
    > Li M., Wang G., Zhao LM., Li SL., Li J. *et al.* (2017). *Differentially expressed lncRNAs and mRNA identified by SEQ analysis in colorectal cancer patients.* Dataset associated with BioProject **PRJNA413956** / Series **GSE104836**. CC BY 4.0. Available at: [https://www.ncbi.nlm.nih.gov/bioproject/PRJNA413956](https://www.ncbi.nlm.nih.gov/bioproject/PRJNA413956)
  * **Reuse:** Data assets generated here (quant files, output tables) may be shared under **CC BY 4.0**. Code snippets within this README and the Jupyter notebook are under the **MIT License**.

-----

## Acknowledgements ğŸ™

  * GENCODE project for the reference transcriptome.
  * Developers of Salmon, Trim Galore\!, FastQC, Cutadapt, SRA-Toolkit, Entrez Direct, GNU Parallel, PySpark, pyfastx, pandas, Matplotlib, and Seaborn.

<!-- end list -->
