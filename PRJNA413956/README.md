
# End-to-End Bulk RNA-Seq Pipeline (CRC ¬∑ PRJNA413956)

A reproducible workflow using **Conda**, command-line tools (**SRA-Toolkit**, **Trim Galore!**, **Salmon**), and **PySpark**/**pyfastx** to analyze transcript quantifications from the first 10 samples (5 Tumor/5 Normal pairs) of the colorectal cancer (CRC) study **PRJNA413956**. This repository provides **pre-computed Salmon quantifications** and the analysis notebook. üß¨

---

## Data Source & Availability

-   **Pre-computed Data:** Salmon quantification results (`quant.sf` files) for the first 10 samples (SRR6191649‚ÄìSRR6191658) are available for download from the **[Releases Page](https://github.com/Makayacine/Transcriptomics/releases/tag/v1.0.0)** of this repository. Look for the `PRJNA413956_quants_v1.tar.gz` archive and its corresponding checksum file (`.sha256`). üíæ
-   **Original Study:**
    -   **BioProject:** PRJNA413956 ‚Äî ‚ÄúDifferentially expressed lncRNAs and mRNA identified by SEQ analysis in colorectal cancer patients.‚Äù ([NCBI BioProject page](https://www.ncbi.nlm.nih.gov/bioproject/PRJNA413956))
    -   **GEO Series:** GSE104836 ‚Äî *10 paired tissues (non-tumor and CRC) generated by deep sequencing.* ([GEO series page](https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE104836))

---

## Getting Started

1.  **Download Data:** Go to the **[Releases Page](https://github.com/Makayacine/Transcriptomics/releases/tag/v1.0.0)** and download:
    * `PRJNA413956_quants_v1.tar.gz`
    * `PRJNA413956_quants_v1.tar.gz.sha256`
2.  **Verify Integrity:**
    ```bash
    sha256sum -c PRJNA413956_quants_v1.tar.gz.sha256
    # Expected output: PRJNA413956_quants_v1.tar.gz: OK
    ```
3.  **Extract Data:**
    ```bash
    tar -xzvf PRJNA413956_quants_v1.tar.gz
    # This will create the 'quants/' directory structure.
    ```
4.  **Set up Environment:** (See Requirements below)
    ```bash
    conda env create -f environment.yml
    conda activate rnaseq
    ```
5.  **Run Analysis:** Open and run the **`PRJNA413956.ipynb`** notebook. Ensure the `gencode.v46.transcripts.fa` file is in the project root.

---

## Repository Layout (After Extraction)

````

PRJNA413956/
‚îú‚îÄ‚îÄ Dockerfile                     \# Docker configuration (if used)
‚îú‚îÄ‚îÄ PRJNA413956.ipynb              \# PySpark/pyfastx analysis notebook
‚îú‚îÄ‚îÄ README.md                      \# This file
‚îú‚îÄ‚îÄ gencode.v46.transcripts.fa     \# Transcriptome FASTA (required for notebook)
‚îú‚îÄ‚îÄ gencode.v46.transcripts.fa.fxi \# pyfastx index (generated by notebook)
‚îî‚îÄ‚îÄ quants/                        \# Salmon results (extracted from .tar.gz)
‚îú‚îÄ‚îÄ SRR\*\_quant/
‚îÇ   ‚îú‚îÄ‚îÄ quant.sf
‚îÇ   ‚îú‚îÄ‚îÄ cmd\_info.json
‚îÇ   ‚îî‚îÄ‚îÄ lib\_format\_counts.json
‚îî‚îÄ‚îÄ quants\_manifest.csv        \# Included in the archive

````

---

## Requirements (for Analysis Notebook)

A Conda environment is recommended.

```yaml
# environment.yml
name: rnaseq
channels: [conda-forge, bioconda, defaults]
dependencies:
  # Python & Data Analysis
  - python=3.11
  - pyspark
  - pandas
  - matplotlib
  - seaborn
  - pyfastx
  - scipy        # For linregress
  - statsmodels  # For LOESS smoothing
  - fpdf         # For PDF report generation (optional)

  # Bioinformatics CLI Tools (Needed only if reproducing quantifications)
  - entrez-direct
  - sra-tools
  - trim-galore
  - fastqc
  - cutadapt
  - salmon
  - parallel
````

**Setup**

```bash
conda env create -f environment.yml
conda activate rnaseq
```

**Reference Files (for Analysis Notebook)**

  * The **FASTA** file (`gencode.v46.transcripts.fa`) must be placed in the project root.

-----

## Reproducing Quantifications (Optional) ‚öôÔ∏è

If you wish to regenerate the `quants/` directory from the raw SRA data instead of using the provided download, you will need the full Conda environment (including CLI tools) and a **Salmon index** built from the reference transcriptome.

Execute the following script from the project root directory. **Ensure you update `/path/to/your/salmon_index`**.

```bash
#!/usr/bin/env bash
set -euo pipefail

# --- Configuration ---
BIOPROJECT="PRJNA413956"
SALMON_INDEX="/path/to/your/salmon_index" # <<< UPDATE THIS PATH
THREADS=8
PARALLEL_JOBS=4
SRR_COUNT=10

# --- Script ---
echo "Fetching SRR IDs for ${BIOPROJECT}..."
SRR_FILE="${BIOPROJECT}_srr_ids.txt"
esearch -db sra -query "${BIOPROJECT}" \
  | efetch -format runinfo \
  | cut -d',' -f1 \
  | grep '^SRR' \
  | head -n ${SRR_COUNT} > "${SRR_FILE}"

echo "Downloading SRR files in parallel (Jobs=${PARALLEL_JOBS})..."
cat "${SRR_FILE}" | parallel -j ${PARALLEL_JOBS} 'echo "Prefetching {}..."; prefetch --verify no {}'

echo "Converting SRA to FASTQ and trimming reads..."
cat "${SRR_FILE}" | while read SRR; do
  echo "Processing ${SRR}..."
  if [[ ! -f "${SRR}_1.fastq.gz" || ! -f "${SRR}_2.fastq.gz" ]]; then
    fastq-dump --split-files --gzip "${SRR}"
  else
    echo "  FASTQ files already exist, skipping fastq-dump."
  fi
  if [[ ! -f "${SRR}_1_val_1.fq.gz" || ! -f "${SRR}_2_val_2.fq.gz" ]]; then
    trim_galore --paired --fastqc --cores 4 "${SRR}_1.fastq.gz" "${SRR}_2.fastq.gz"
  else
    echo "  Trimmed files already exist, skipping trim_galore."
  fi
  # Optional: Clean up intermediate FASTQ files if desired
  # rm -f "${SRR}_1.fastq.gz" "${SRR}_2.fastq.gz"
done

echo "Quantifying expression with Salmon (Threads=${THREADS})..."
mkdir -p quants
for R1 in *_1_val_1.fq.gz; do
  SAMPLE="${R1%_1_val_1.fq.gz}"
  OUTDIR="quants/${SAMPLE}_quant"
  # Check if SAMPLE is in our SRR list before quantifying
  if grep -q "^${SAMPLE}$" "${SRR_FILE}"; then
      if [[ ! -f "${OUTDIR}/quant.sf" ]]; then
        echo "  Quantifying ${SAMPLE}..."
        salmon quant \
          -i "${SALMON_INDEX}" \
          -l A \
          -1 "${SAMPLE}_1_val_1.fq.gz" \
          -2 "${SAMPLE}_2_val_2.fq.gz" \
          --validateMappings \
          -p ${THREADS} \
          -o "${OUTDIR}"
      else
        echo "  Quantification for ${SAMPLE} already exists, skipping."
      fi
  fi
done

echo "Command-line pipeline complete. ‚úÖ"
```

-----

## Downstream Analysis (PySpark + pyfastx) üìä

Open and run the **`PRJNA413956.ipynb`** notebook using the `quants/` directory (either downloaded or generated) to:

1.  Load `quant.sf` data into Spark.
2.  Parse transcript features (GC%, length) using pyfastx.
3.  Add sample condition metadata ('Tumor'/'Normal').
4.  Join data and generate exploratory plots comparing expression vs. GC content between Tumor and Normal samples.
5.  (Optional) Save plots to PDF/PNG and generate a summary PDF report.

-----

## Outputs (Generated by Notebook)

  * **`outputs/figures/`**: Publication-ready PDF/PNG figures.
  * **`outputs/data/`**: CSV files containing aggregated data used for plots.
  * **(Optional)** `RNASeq_Report_PRJNA413956.pdf`: Summary report.

-----

## Reproducibility Notes

  * Salmon `quant.sf` files contain the primary quantification data. `cmd_info.json` provides provenance for the Salmon run.
  * For archival (e.g., on Zenodo), consider packaging the relevant files within the `quants/` directory (e.g., `quant.sf`, `cmd_info.json`, `lib_format_counts.json`) along with a manifest file.

**Example Manifest Creation:**

```bash
{
  echo "Sample,quant_sf,cmd_info,lib_format_counts"
  # Use find for robustness, especially if directory structure varies
  find quants -maxdepth 2 -type f -name 'quant.sf' | while read QSF; do
    DDIR=$(dirname "$QSF")
    SAMPLE=$(basename "$DDIR")
    CMD_INFO="${DDIR}/cmd_info.json"
    LIB_COUNTS="${DDIR}/lib_format_counts.json"
    # Check if other files exist, provide placeholders if not
    [[ ! -f "$CMD_INFO" ]] && CMD_INFO="NA"
    [[ ! -f "$LIB_COUNTS" ]] && LIB_COUNTS="NA"
    echo "$SAMPLE,$QSF,$CMD_INFO,$LIB_COUNTS"
  done
} > quants_manifest.csv
```

-----

## Citation & Licensing

  * **Source Study:** Please cite the original publication associated with PRJNA413956/GSE104836 when using these data or results derived from them.
    > Li M., Wang G., Zhao LM., Li SL., Li J. *et al.* (2017). *Differentially expressed lncRNAs and mRNA identified by SEQ analysis in colorectal cancer patients.* Dataset associated with BioProject **PRJNA413956** / Series **GSE104836**. CC BY 4.0. Available at: [https://www.ncbi.nlm.nih.gov/bioproject/PRJNA413956](https://www.ncbi.nlm.nih.gov/bioproject/PRJNA413956)
  * **Reuse:** Data assets provided in Releases (`quants/`) are under **CC BY 4.0**. Code snippets (README, Jupyter notebook) are under the **MIT License**.

-----

## Acknowledgements üôè

  * GENCODE project for the reference transcriptome.
  * Developers of Salmon, Trim Galore\!, FastQC, Cutadapt, SRA-Toolkit, Entrez Direct, GNU Parallel, PySpark, pyfastx, pandas, Matplotlib, and Seaborn.

<!-- end list -->

